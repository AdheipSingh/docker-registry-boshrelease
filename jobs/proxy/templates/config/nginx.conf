user vcap;
worker_processes 8;
pid /var/vcap/sys/run/proxy/proxy.pid;

events {
  worker_connections 1024;
}

## Set a variable to help us decide if we need to add the
## 'Docker-Distribution-Api-Version' header.
## The registry always sets this header.
## In the case of nginx performing auth, the header will be unset
## since nginx is auth-ing before proxying.
map $upstream_http_docker_distribution_api_version $docker_distribution_api_version {
  'registry/2.0' '';
  default registry/2.0;
}

http {
  access_log /var/vcap/sys/log/proxy/access.log;
  error_log  /var/vcap/sys/log/proxy/error.log;

  # Recommendations from https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html
  ssl_protocols TLSv1.1 TLSv1.2;
  ssl_ciphers 'EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH';
  ssl_prefer_server_ciphers on;
  ssl_session_cache shared:SSL:10m;

  upstream docker {
  <% p('docker.proxy.backend.hosts').each do |ip| %>
    server <%= ip %>:<%= p('docker.proxy.backend.port') %>;
  <% end %>
  }

  server {
  <% if p('docker.proxy.ssl.cert') %>
    listen 443;
    ssl on;
    ssl_certificate     /var/vcap/jobs/proxy/tls/cert.pem;
    ssl_certificate_key /var/vcap/jobs/proxy/tls/key.pem;
  <% else %>
    listen 80;
    ssl off;
  <% end %>
    server_name proxyregistry;

    client_max_body_size 0;
    chunked_transfer_encoding on;

    location /v2/ {
      # Do not allow connections from docker 1.5 and earlier
      # docker pre-1.6.0 did not properly set the user agent on ping, catch "Go *" user agents
      if ($http_user_agent ~ "^(docker\/1\.(3|4|5(?!\.[0-9]-dev))|Go ).*\$" ) {
        return 404;
      }
      proxy_set_header Host              $host;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Original-URI    $request_uri;

      proxy_pass_header Server;
      proxy_read_timeout 3600;

      proxy_pass http://docker;
    }
  }
}
